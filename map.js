"use strict";window.onload=function(){document.onkeydown=function(){let t=window.event||arguments[0];return 123!=t.keyCode&&((!t.ctrlKey||!t.shiftKey||73!=t.keyCode)&&((!t.ctrlKey||85!=t.keyCode)&&void 0))},document.oncontextmenu=function(){return!1}};var city,map=new BMap.Map("map",{enableMapClick:!1}),myCity=new BMap.LocalCity;myCity.get(getCity),map.enableScrollWheelZoom(),map.enableKeyboard(),map.enableInertialDragging(),map.disableDoubleClickZoom(),map.addControl(new BMap.CityListControl({anchor:BMAP_ANCHOR_TOP_LEFT}));var cr=new BMap.CopyrightControl({anchor:BMAP_ANCHOR_BOTTOM_LEFT,offset:new BMap.Size(472,2)});map.addControl(cr),cr.addCopyright({id:1,content:"&copy;温州公交吧 | 中华全知道"});var inputLine,lineOpacity,currentPolyline,polyline,diyLine,diyStation,first,last,brtlist,readyAdd=[],addPoint=[],stationIcon=new BMap.Icon("station_icon.png",new BMap.Size(12,12)),getPolylineOptions=function(){return{strokeColor:$("#strokeColor").val(),strokeWeight:$("#strokeWeight").val(),strokeOpacity:$("#strokeOpacity").val(),strokeStyle:$("#strokeStyle").val()}},bus=new BMap.BusLineSearch(map,{onGetBusListComplete:function(t){let e=$("#busListItem").val(),i=t.getBusListItem(e);bus.getBusLine(i)},onGetBusLineComplete:function(t){polyline=new BMap.Polyline(t.getPath(),getPolylineOptions());let e=t.name.substr(0,t.name.indexOf("("));if(map.addOverlay(polyline),"true"==$("#strokeStation").val())for(let i=0;i<t.getNumBusStations();i++){let n=t.getBusStation(i),a=new BMap.Marker(n.position,{icon:stationIcon});map.addOverlay(a),a.enableDragging(),a.setTitle(e+":"+n.name),a.addEventListener("click",function(e){let i={width:250,height:80,title:e.target.getTitle().substr(e.target.getTitle().indexOf(":")+1)},n=t.name,a=new BMap.InfoWindow(n,i),l=new BMap.Point(e.target.getPosition().lng,e.target.getPosition().lat);map.openInfoWindow(a,l)})}polyline.addEventListener("dblclick",function(t){let i=map.getOverlays(),n=i.length;for(let t=0;t<n;t++)"[object Marker]"==i[t].toString()&&i[t].getTitle().substr(0,i[t].getTitle().indexOf(":"))==e?i[t].enableMassClear():i[t].disableMassClear();t.target.enableMassClear(),map.clearOverlays(),readyAdd.pop(e)}),polyline.addEventListener("mouseover",function(t){t.target!=currentPolyline&&(currentPolyline=t.target,lineOpacity=currentPolyline.getStrokeOpacity(),currentPolyline.setStrokeOpacity("1"))}),polyline.addEventListener("mouseout",function(t){t.target.setStrokeOpacity(lineOpacity)})}});function getCity(t){t?(city=t.name,map.centerAndZoom(city,13)):city="温州市"}function addLine(t){-1==$.inArray(t,readyAdd)?(bus.getBusList(t),readyAdd.push(t),$("#editBtn").removeClass("disable")):alert("该路线已添加")}function clear(){let t=map.getOverlays().length;for(let e=0;e<t;e++)map.getOverlays()[e].enableMassClear();map.clearOverlays(),readyAdd=[],addPoint=[],$("#brtBtn").attr("disabled",!1).removeClass("disable"),$("#editBtn").addClass("disable").text("启用路径编辑"),$("#stopBtn").addClass("disable")}map.addEventListener("moveend",function(){(new BMap.Geocoder).getLocation(map.getCenter(),function(t){city=t.addressComponents.city})}),$("#container").click(function(){if(diyLine&&!last){addPoint=[];let t=map.getOverlays().length;for(let e=0;e<t;e++)map.clearOverlays()}}),$("#busList").bind("input propertychange",function(){inputLine=$("#busList").val()}),$("#busList").focus(function(){inputLine=$("#busList").val(),$(this).val("")}),$("#busList").blur(function(){$(this).val(inputLine)}),$("#addBtn").click(function(){addLine($("#busList").val().replace("路",""))}),$("#searchBtn").click(function(){if($("#stationList").val()){clear();let t=new BMap.LocalSearch(map,{pageCapacity:1,renderOptions:{map:map,autoViewport:!1},onSearchComplete:function(){if(t.getStatus()==BMAP_STATUS_SUCCESS&&t.getResults().getPoi(0).type==BMAP_POI_TYPE_BUSSTOP){let e=t.getResults().getPoi(0).address.split(";"),i=e.length;for(let t=0;t<i;t++)addLine(e[t])}else alert("未在当前城市查询到该站点，请填写标准的公交站名")}});t.search($("#stationList").val()+"-公交站,",{forceLocal:"ture"})}}),$("#brtBtn").click(function(){switch(city){case"杭州市":brtlist=["B1","B1区间","B2","B2区间","B2C","B4","B4C","B7","B8","B8B","B支1","B支1区间","B支1快线","B支2","B支2C","B支3","B支3C","B支4","B支4快线","B支7","B支7C","B支7D","B支8"];break;case"温州市":brtlist=["B1","B2","B3","B4","B101","B102","B103","B104","B105","B106","B107","B108","B109","B111","B112","B113"];break;case"绍兴市":brtlist=["BRT1号线","BRT3号支线","BRT5号线"];break;case"金华市":brtlist=["B1","B2","B3-A","B3-B","B4","B5","金兰城际公交快线"];break;case"舟山市":brtlist=["快速公交1号线"];break;default:alert("该功能只支持浙江省内。如当前城市有BRT线路，请放大地图再试")}if(void 0!==brtlist){let t=brtlist.length;for(let e=0;e<t;e++)-1==$.inArray(brtlist[e],readyAdd)&&(readyAdd.push(brtlist[e]),bus.getBusList(brtlist[e]));$(this).attr("disabled",!0).addClass("disable")}}),$("#editBtn").click(function(){polyline&&(0==$(this).hasClass("disable")?(polyline.enableEditing(),$(this).addClass("disable").text("停用路径编辑")):(polyline.disableEditing(),$(this).removeClass("disable").text("启用路径编辑")))}),$("#clearBtn").click(function(){clear()}),$("#drawBtn").click(function(){diyLine=first=!0,diyStation=last=!1,map.setDefaultCursor("crosshair"),map.addEventListener("click",function(t){if(diyLine){let e=new BMap.Point(t.point.lng,t.point.lat);addPoint.push(e);let i=new BMap.Polyline(addPoint,getPolylineOptions());if(map.addOverlay(i),first){let e=new BMap.Point(t.point.lng,t.point.lat),i=new BMap.Marker(e,{icon:stationIcon});map.addOverlay(i);let n=new BMap.Label("起点",{offset:new BMap.Size(15,-5)});i.setLabel(n),first=!1}}}),map.addEventListener("dblclick",function(t){if(map.setDefaultCursor("default"),!first){let e=new BMap.Point(t.point.lng,t.point.lat),i=new BMap.Marker(e,{icon:stationIcon});map.addOverlay(i);let n=new BMap.Label("终点",{offset:new BMap.Size(15,-5)});i.setLabel(n);let a=map.getOverlays().length;for(let t=0;t<a;t++)map.clearOverlays();(polyline=new BMap.Polyline(addPoint,getPolylineOptions())).disableMassClear(),map.addOverlay(polyline),addPoint=[],diyLine=!1,$("#editBtn").removeClass("disable"),first=!0,last=!0}})}),$("#stationBtn").click(function(){diyStation=!0,map.setDefaultCursor("pointer"),map.addEventListener("click",function(t){if(diyStation){let e=new BMap.Point(t.point.lng,t.point.lat),i=new BMap.Marker(e,{icon:stationIcon});i.disableMassClear(),map.addOverlay(i),i.addEventListener("dblclick",function(t){t.target.enableMassClear(),map.clearOverlays()})}}),$("#stopBtn").removeClass("disable")}),$("#stopBtn").click(function(){diyStation=!1,$(this).addClass("disable"),map.setDefaultCursor("default")}),$(".set").click(function(){diyLine=diyStation=!1,map.setDefaultCursor("default"),$(this).next().is(":hidden")?($(this).find(".icon").text("-"),$(this).siblings(".set").find(".icon").text("+")):$(this).find(".icon").text("+"),$(this).siblings(".set").next().hide(),$(this).next().slideToggle()});